# GmailからDiscordへの自動転送・自動返信システム 仕様書

## 1. 概要

本システムは、Gmailで受信したメールを送信元のメールアドレスごとに対応するDiscordチャンネルへ自動転送し、さらに転送されたメール内容をもとにChatGPT APIを活用して複数のビジネスメール形式の返信パターンを生成する仕組みです。送信元情報から適切な宛名（〇〇会社 〇〇様）を自動設定し、日程調整に関するメールの場合は、GoogleカレンダーAPIと連携し、実際のスケジュール確認を行った上で適切な返信文（候補日時を含む）を自動生成できるようにします。

---

## 2. システム構成

### 2.1 コンポーネント
- **メール受信モジュール**
  - Gmail APIを利用して、指定のメールアドレスから受信したメールを検知・取得。
- **メール転送モジュール**
  - 受信メールの送信者（またはメールアドレス）に応じて、あらかじめ設定したDiscordチャンネルへメール内容を転送。
- **Discordボット**
  - Discord APIを利用して、各チャンネル内での動作を管理。
  - 転送されたメール内容を受け取り、返信候補生成プロセスを起動。
- **返信生成モジュール**
  - ChatGPT APIを利用して、メール内容に基づいたビジネスメールの返信文を生成。
  - システムプロンプトを状況に応じて調整（通常返信と、Googleカレンダー連携による日程調整返信の2種類以上）。
- **日程調整連携モジュール**
  - GoogleカレンダーAPIを使用し、スケジュールの確認および候補日時の抽出。
  - 日程調整が必要な場合、返信生成モジュールへその情報を付加してプロンプトを調整。
- **宛名管理モジュール**
  - 送信元メールアドレスや署名から会社名・担当者名を抽出・管理。
  - 返信文冒頭の宛名（〇〇会社 〇〇様）を自動生成。

### 2.2 必要なAPI・サービス
- **Gmail API**
  - Gmailからのメール取得、フィルタリング、転送トリガーとして利用。
- **Discord API**
  - Discordボットの作成、各チャンネルへの投稿、メッセージ管理に使用。
- **OpenAI ChatGPT API**
  - メール内容に応じた返信パターン（ビジネスメール形式）の自動生成。
- **GoogleカレンダーAPI**
  - 日程調整のメールに対し、現在のスケジュール状況を照会し、返信文へ候補日時を組み込む。
- **その他必要なもの**
  - 各APIの認証情報（APIキー、OAuthトークン等）の管理仕組み
  - 送信者メールアドレスとDiscordチャンネルのマッピング設定（データベースまたは設定ファイル）
  - ログ管理・エラーハンドリング機能

---

## 3. 機能詳細

### 3.1 メール受信および転送
- **メール受信条件**
  - Gmailアカウントに届いたメールの送信元アドレスを確認。
  - 予め設定された特定のメールアドレスからのメールを検知。
- **転送先の設定**
  - 設定ファイルまたはデータベースに、各送信元メールアドレスに対応するDiscordチャンネルIDを登録。
  - 受信メールが特定のアドレスからの場合、対応するDiscordチャンネルへ転送する。

### 3.2 Discordボットの動作
- **チャンネル内メッセージ監視**
  - 転送されたメール内容が投稿されたチャンネル内で、ボットが自動的に反応。
- **返信候補生成のトリガー**
  - メール転送後、ボットがChatGPT API呼び出しのためのイベントを発行。
  - メール内容の解析により、通常返信か日程調整返信かの判断を行う。

### 3.3 返信文生成
- **通常返信**
  - メール本文や件名、必要な情報をもとに、ビジネスメールとして適切な返信文を生成。
  - 複数の返信パターンを生成し、ユーザーが選択可能な形でDiscord上に表示。
- **日程調整返信**
  - メール内容に日程調整の意図が認められる場合、GoogleカレンダーAPIで利用可能な日時を取得。
  - 取得した候補日時をプロンプトに組み込み、調整候補を含む返信文を生成。
- **宛名自動設定**
  - 送信元メールアドレス情報から会社名・担当者名を抽出し、「〇〇会社 〇〇様」の形式で返信文の冒頭に自動挿入。

### 3.4 システムプロンプトの調整
- **プロンプト設定**
  - ChatGPT APIに送信するシステムプロンプトは、通常のビジネスメール返信と日程調整返信で異なる文言・フォーマットを用意。
  - メール内容のキーワード解析により、適切なプロンプトを選択・適用する仕組みを実装。

### 3.5 宛名自動設定の機能詳細
- **宛名情報の抽出と管理**
  - **メールアドレス解析**: 送信元メールアドレスのドメイン部分から会社名を推測
  - **署名情報活用**: メール本文内の署名から送信者の会社名と担当者名を抽出
  - **データベース構築**: 過去のやり取りから会社名・担当者名とメールアドレスの対応関係を学習
  - **手動登録機能**: 未登録の送信元については手動で会社名・担当者名を登録可能に
- **宛名フォーマット**
  - 基本形式: 「〇〇会社 〇〇様」
  - 会社名のみ判明: 「〇〇会社 ご担当者様」
  - 担当者名のみ判明: 「〇〇様」
  - 両方不明: 「お世話になっております」など一般的な挨拶で開始

---

## 4. ワークフロー

1. **メール受信**
   - Gmail APIが定期的またはWebhookによりメール受信を検知。
2. **送信者判別および転送**
   - 受信メールの送信者アドレスを参照し、対応するDiscordチャンネルへ転送。
3. **Discordボットの起動**
   - 転送先チャンネルに投稿されたメール内容を、Discordボットが受信。
4. **返信候補生成処理**
   - 送信元情報から適切な宛名（〇〇会社 〇〇様）を抽出・設定
   - ボットがメール内容を解析し、ChatGPT APIに問い合わせるためのプロンプトを決定。
   - 日程調整が必要な場合は、GoogleカレンダーAPIを呼び出して候補日時を取得。
5. **返信パターンの生成**
   - ChatGPT APIが複数の返信パターンを生成し、ボットがその結果をDiscordチャンネルに投稿。
6. **ユーザーによる選択および送信**
   - ユーザーが提示された返信パターンから適切なものを選択、または編集後に実際の返信メールとして送信。

---

## 5. セキュリティ・認証・運用管理

### 5.1 API認証とセキュリティ
- 各API（Gmail、Googleカレンダー、Discord、ChatGPT）の認証情報は、安全な環境変数または専用の認証サーバーにより管理。
- OAuth認証を利用し、不正アクセスを防止。
- 転送されるメール内容や返信履歴のログは、適切に暗号化・アクセス制御されたストレージに保管。
- ユーザーの個人情報や機密情報の取り扱いに注意する。

### 5.2 エラーハンドリングとモニタリング
- 各コンポーネントでエラー発生時のリトライやログ記録の仕組みを実装。
- システムの動作状況を監視するためのモニタリングツール（例：Sentry、Prometheusなど）を導入。

### 5.3 運用・メンテナンス
- 定期的なAPIのアップデート確認およびセキュリティパッチの適用。
- ユーザーからのフィードバックを受け、返信パターンやプロンプトの改善を継続的に行う。

---

## 6. 開発・実装環境

### 6.1 言語・フレームワーク
- サーバーサイド：Node.js、Python、またはその他適切な言語（API連携が容易なもの）。
- Discordボット：Discord.js（Node.jsの場合）またはdiscord.py（Pythonの場合）など。

### 6.2 データベース
- 送信者メールアドレスとDiscordチャンネルのマッピング、ログ管理のために、軽量なRDBMS（例：SQLite、PostgreSQL）やNoSQLを利用。

### 6.3 ホスティング環境
- クラウドサーバー（例：AWS、Google Cloud、Herokuなど）上で稼働。
- 必要に応じたスケーラビリティの確保。

---

## 7. よくある質問（FAQ）

### 7.1 返信候補はどのように選択・送信されますか？
Discord上に生成された複数の返信パターンが表示され、ユーザーがその中から適切なものを選択するか編集した上で、実際の返信メールとして送信します。宛名部分も確認・編集できます。

### 7.2 メール内容の解析はどのように行われますか？
メール内容のキーワード解析により、日程調整の意図が含まれるかを判断します。「面談希望」「日程調整」「打ち合わせ」などのキーワードがあれば日程調整返信として処理します。同時に送信者情報も解析し適切な宛名を設定します。

### 7.3 システムのダウンタイムが発生した場合はどうなりますか？
未処理のメールがある場合は、システム復旧後に処理キューから順次処理します。重要なメールが見逃されないよう、エラーログと未処理メール一覧を管理者に通知する仕組みが必要です。

### 7.4 APIの使用制限にはどう対応しますか？
各APIの使用制限を監視し、制限に近づいた場合はレート制限を設けます。特にChatGPT APIやGmail APIの利用量が多い場合は、処理の優先順位付けや一時的な機能制限などの対策が必要です。

### 7.5 宛名情報の学習はどのように行われますか？
一度やり取りしたメールアドレスと対応する会社名・担当者名をデータベースに保存します。メール署名の解析や返信時に手動で修正された宛名情報も学習し、次回からの精度向上に活用します。

### 7.6 宛名情報の更新はどうしますか？
同じメールアドレスでも担当者が変わる場合があるため、最新のメールに含まれる署名情報を優先的に使用します。また、管理画面からいつでも手動で情報を更新できる仕組みも用意します。

---

## 8. 重要用語・概念の解説

| 用語 | 解説 |
|------|------|
| Gmail API | Gmailのメールボックスにプログラムからアクセスするためのインターフェース。メールの取得、送信、ラベル操作などが可能。 |
| Discord API | Discordのチャンネルやメッセージを操作するためのインターフェース。ボットを作成してチャット機能を自動化できる。 |
| ChatGPT API | OpenAIが提供する自然言語処理APIで、文脈を理解した高品質な文章生成が可能。 |
| OAuth認証 | ユーザーのパスワードを直接扱わずにサードパーティアプリケーションに限定的な権限を付与できる認証方式。 |
| システムプロンプト | ChatGPT APIに送信する指示文で、AIの応答内容やフォーマットを詳細に制御するためのもの。 |
| Webhook | 特定のイベント発生時に自動的に通知を送信する仕組み。リアルタイム処理に有効。 |
| 宛名自動設定 | メールアドレスや署名から会社名・担当者名を抽出し、返信文の冒頭に「〇〇会社 〇〇様」の形式で自動挿入する機能。 |

---

## 9. まとめ

本仕様書では、Gmail API、Discord API、OpenAI ChatGPT API、GoogleカレンダーAPIを中核とした、メール転送と自動返信の統合システムの全体像と各機能要件、連携フロー、セキュリティ対策、及び運用面での考慮事項についてまとめました。

特に送信元情報から適切な宛名を自動設定する機能に重点を置き、「〇〇会社 〇〇様」のようなパーソナライズされた返信を可能にします。これにより、メール返信にかかる手間を大幅に削減しつつ、ビジネスコミュニケーションの質を保つことが期待されます。